<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Excel Analysis Bot</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="main-layout">
        <!-- Sidebar: File Management -->
        <div class="sidebar">
            <div class="sidebar-header">
                Excel Bot
            </div>

            <div class="drop-zone" id="drop-zone">
                <div>DROP FILES / FOLDERS</div>
                <div style="font-size: 0.8em; margin-top: 5px;">or click to browse</div>
                <!-- multiple attribute for bulk, user handles folders via system dialog usually or drag drop -->
                <input type="file" id="file-input" style="display:none" multiple accept=".xlsx,.xls">
                <input type="file" id="folder-input" style="display:none" webkitdirectory directory multiple>
            </div>

            <div style="padding: 0 20px; display: flex; gap: 5px;">
                <button style="width: 100%; padding: 5px;"
                    onclick="document.getElementById('folder-input').click()">Check Folder</button>
            </div>


            <div class="files-list-container" id="file-list">
                <!-- File Items will go here -->
            </div>
            <!-- Settings Button -->
            <div style="padding: 10px 20px; border-top: 2px solid #000000; margin-top: auto;">
                <button style="width: 100%; border: 1px solid #000000;" onclick="openSettings()">Settings ⚙️</button>
            </div>
        </div>

        <!-- Main Workspace: Chat & Edit -->
        <div class="workspace">
            <div class="workspace-header" id="workspace-header">
                Select a file to begin
            </div>

            <div class="chat-history" id="chat-history">
                <div class="empty-state">
                    No active session
                </div>
            </div>

            <div class="input-area">
                <textarea id="query-text" placeholder="Ask a question or describe an edit..."></textarea>
                <div class="button-group">
                    <button id="ask-btn">Ask</button>
                    <button id="edit-btn">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:#FFF; border:2px solid #000000; padding:30px; width:500px; box-shadow: 10px 10px 0px #000000;">
            <h3 style="margin-top:0;">Settings</h3>

            <label style="display:block; margin-bottom:5px; font-weight:bold;">Active Provider:</label>
            <select id="provider-select"
                style="width:100%; padding:10px; margin-bottom:10px; border:2px solid #000000;">
                <option value="openai">OpenAI (GPT)</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="gemini">Google (Gemini)</option>
                <option value="openrouter">OpenRouter (All)</option>
            </select>

            <label style="display:block; margin-bottom:5px; font-weight:bold;">Model Name:</label>
            <input type="text" id="model-input" placeholder="e.g. gpt-4o, claude-3-opus-20240229"
                style="width:100%; padding:10px; margin-bottom:20px; border:2px solid #000000;">

            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:0.9em;">OpenAI API Key <span id="status-openai"></span></label>
                <input type="password" id="key-openai" placeholder="sk-..."
                    style="width:100%; padding:8px; border:1px solid #ccc;">
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:0.9em;">Anthropic API Key <span
                        id="status-anthropic"></span></label>
                <input type="password" id="key-anthropic" placeholder="sk-ant-..."
                    style="width:100%; padding:8px; border:1px solid #ccc;">
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:0.9em;">Gemini API Key <span id="status-gemini"></span></label>
                <input type="password" id="key-gemini" placeholder="AIza..."
                    style="width:100%; padding:8px; border:1px solid #ccc;">
            </div>

            <div style="margin-bottom:20px;">
                <label style="display:block; font-size:0.9em;">OpenRouter Key <span
                        id="status-openrouter"></span></label>
                <input type="password" id="key-openrouter" placeholder="sk-or-..."
                    style="width:100%; padding:8px; border:1px solid #ccc;">
            </div>

            <div
                style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; padding-top:15px;">
                <div style="font-size:0.8em; color:#555;">
                    Created by <b>RuturajS</b> | <a href="https://github.com/RuturajS/rambot" target="_blank"
                        style="color:#000;">GitHub</a>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="closeSettings()">Close</button>
                    <button onclick="saveSettings()" style="background:#000; color:#FFF;">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const folderInput = document.getElementById('folder-input');
        const fileListContainer = document.getElementById('file-list');
        const workspaceHeader = document.getElementById('workspace-header');
        const chatHistory = document.getElementById('chat-history');
        const queryText = document.getElementById('query-text');

        // Settings Elements
        const settingsModal = document.getElementById('settings-modal');
        // Inputs
        const providerSelect = document.getElementById('provider-select');
        const modelInput = document.getElementById('model-input');
        const keyOpenAI = document.getElementById('key-openai');
        const keyAnthropic = document.getElementById('key-anthropic');
        const keyGemini = document.getElementById('key-gemini');
        const keyOpenRouter = document.getElementById('key-openrouter');

        // State
        let selectedHash = null;
        let selectedFilename = null;

        // --- Settings Logic ---
        function openSettings() {
            settingsModal.style.display = 'flex';
            checkKeyStatus();
            // Clear inputs for security, user re-enters to update
            keyOpenAI.value = '';
            keyAnthropic.value = '';
            keyGemini.value = '';
            keyOpenRouter.value = '';
        }

        function closeSettings() {
            settingsModal.style.display = 'none';
        }

        function checkKeyStatus() {
            fetch('/settings/status').then(r => r.json()).then(d => {
                providerSelect.value = d.provider;
                modelInput.value = d.model || '';
                updateStatusIcon('status-openai', d.openai);
                updateStatusIcon('status-anthropic', d.anthropic);
                updateStatusIcon('status-gemini', d.gemini);
                updateStatusIcon('status-openrouter', d.openrouter);
            });
        }

        function updateStatusIcon(id, isActive) {
            document.getElementById(id).textContent = isActive ? "✅" : "❌";
        }

        function saveSettings() {
            let fd = new FormData();
            fd.append('provider', providerSelect.value);
            fd.append('model', modelInput.value.trim());

            // Only send keys if they are typed
            if (keyOpenAI.value.trim()) fd.append('openai_key', keyOpenAI.value.trim());
            if (keyAnthropic.value.trim()) fd.append('anthropic_key', keyAnthropic.value.trim());
            if (keyGemini.value.trim()) fd.append('gemini_key', keyGemini.value.trim());
            if (keyOpenRouter.value.trim()) fd.append('openrouter_key', keyOpenRouter.value.trim());

            fetch('/settings/save', { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    alert(d.message);
                    closeSettings();
                });
        }

        // --- Upload Handling ---
        dropZone.onclick = (e) => {
            // Prefer file input for clicking, folder input via button
            if (e.target.tagName !== 'INPUT') fileInput.click();
        };

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        };

        dropZone.ondragleave = () => {
            dropZone.classList.remove('dragover');
        };

        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');

            // Handle Items (Files or Directories)
            const items = e.dataTransfer.items;
            if (items) {
                handleItems(items);
            } else {
                // Fallback for files only
                upload(e.dataTransfer.files);
            }
        };

        fileInput.onchange = (e) => {
            if (e.target.files.length) upload(e.target.files);
        };

        folderInput.onchange = (e) => {
            if (e.target.files.length) upload(e.target.files);
        };

        async function handleItems(items) {
            // Basic recursive directory reading logic if needed, 
            // but File API often flattens folders dropped on 'files' if webkitGetAsEntry is used.
            // For MVP, standard drop usually results in FileList.
            // If items API is available, we can distinguish.

            let files = [];
            // Simplified handling: just grab all accessible files from the DataTransfer
            // Browsers are tricky with folders.
            // If it's a simple drag/drop of folder, Chrome puts files in files list.

            const dtFiles = [];
            for (let i = 0; i < items.length; i++) {
                const item = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : items[i];
                if (item) {
                    await traverseFileTree(item, dtFiles);
                }
            }
            if (dtFiles.length > 0) upload(dtFiles);
        }

        async function traverseFileTree(item, fileList) {
            if (item.isFile) {
                return new Promise((resolve) => {
                    item.file((file) => {
                        fileList.push(file);
                        resolve();
                    });
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                return new Promise((resolve) => {
                    dirReader.readEntries(async (entries) => {
                        for (let i = 0; i < entries.length; i++) {
                            await traverseFileTree(entries[i], fileList);
                        }
                        resolve();
                    });
                });
            }
        }

        function upload(files) {
            if (files.length === 0) return;

            // Filter for Excel
            let validFiles = [];
            for (let i = 0; i < files.length; i++) {
                if (files[i].name.match(/\.(xlsx|xls)$/i)) {
                    validFiles.push(files[i]);
                }
            }

            if (validFiles.length === 0) {
                alert("No Excel files found in selection.");
                return;
            }

            let fd = new FormData();
            validFiles.forEach(f => fd.append('files', f));

            appendMessage(`Uploading ${validFiles.length} files...`, 'bot');

            fetch('/upload', { method: 'POST', body: fd })
                .then(r => r.json())
                .then(data => {
                    appendMessage(`Successfully uploaded ${data.length} files.`, 'bot');
                    loadList();
                })
                .catch(e => {
                    console.error(e);
                    appendMessage("Upload Error", 'bot');
                });
        }

        // --- File List & Selection ---
        function loadList() {
            fetch('/list').then(r => r.json()).then(data => {
                fileListContainer.innerHTML = '';
                data.forEach(f => {
                    let div = document.createElement('div');
                    div.className = 'file-item';
                    if (f.hash_id === selectedHash) div.classList.add('selected');

                    div.innerHTML = `
                        <span class="file-name">${f.filename}</span>
                        <span class="file-meta">${f.upload_date.split('T')[0]} | ${f.upload_source}</span>
                    `;
                    div.onclick = () => selectFile(f);
                    fileListContainer.appendChild(div);
                });
            });
        }

        function selectFile(f) {
            selectedHash = f.hash_id;
            selectedFilename = f.filename;

            // Update UI
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
            loadList(); // Brute force redraw to apply class or complex selector

            workspaceHeader.textContent = selectedFilename;

            // Clear Chat or Load History? For now, clear to signal new session context
            chatHistory.innerHTML = '';
            appendMessage(`Active context: ${f.filename}`, 'bot');
            appendMessage('Ask a question or describe an edit.', 'bot');
        }

        loadList();

        // --- Chat & Actions ---
        function appendMessage(text, sender) {
            let msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            msgDiv.textContent = text;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        document.getElementById('ask-btn').onclick = () => performAction('/query', 'query');
        document.getElementById('edit-btn').onclick = () => performAction('/edit', 'instruction');

        function performAction(endpoint, paramName) {
            if (!selectedHash) {
                alert("Please select a file first.");
                return;
            }
            let q = queryText.value.trim();
            if (!q) return;

            appendMessage(q, 'user');
            queryText.value = '';

            // Loading state
            let loadingMsg = document.createElement('div');
            loadingMsg.className = 'message bot';
            loadingMsg.textContent = 'Processing...';
            chatHistory.appendChild(loadingMsg);

            let fd = new FormData();
            fd.append('hash_id', selectedHash);
            fd.append(paramName, q);

            fetch(endpoint, { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    chatHistory.removeChild(loadingMsg);
                    if (d.response) {
                        appendMessage(d.response, 'bot');
                    } else if (d.status === 'success') {
                        appendMessage(`Success: ${d.message}. New version created with hash: ${d.new_hash}`, 'bot');
                        loadList(); // Refresh list to show new file
                    } else {
                        appendMessage(`Error: ${d.message}`, 'bot');
                    }
                })
                .catch(() => {
                    chatHistory.removeChild(loadingMsg);
                    appendMessage("Network Error", 'bot');
                });
        }
    </script>
</body>

</html>